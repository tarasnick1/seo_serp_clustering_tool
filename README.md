# ๐ SERP Hard/Soft Clustering Engine v2.2 โ ะะพะบัะผะตะฝัะฐัะธั

## ะะณะปะฐะฒะปะตะฝะธะต

1. [ะะฑัะฐั ะธะดะตั](#1-ะพะฑัะฐั-ะธะดะตั)
2. [ะััะธัะตะบัััะฐ ะฟะฐะนะฟะปะฐะนะฝะฐ](#2-ะฐััะธัะตะบัััะฐ-ะฟะฐะนะฟะปะฐะนะฝะฐ)
3. [Soft-ะบะปะฐััะตัะธะทะฐัะธั](#3-soft-ะบะปะฐััะตัะธะทะฐัะธั-ะฟะพะฟะฐัะฝะพะต-ััะปะพะฒะธะต)
4. [Hard-ะบะปะฐััะตัะธะทะฐัะธั](#4-hard-ะบะปะฐััะตัะธะทะฐัะธั-ะณะปะพะฑะฐะปัะฝะพะต-ััะปะพะฒะธะต)
5. [ะกัะฐะฒะฝะตะฝะธะต Soft ะธ Hard](#5-ััะฐะฒะฝะตะฝะธะต-soft-ะธ-hard)
6. [ะะตัะฐะปัะฝะพะต ะพะฟะธัะฐะฝะธะต ะบะฐะถะดะพะณะพ ัะฐะณะฐ](#6-ะดะตัะฐะปัะฝะพะต-ะพะฟะธัะฐะฝะธะต-ะบะฐะถะดะพะณะพ-ัะฐะณะฐ)
7. [ะะพััะพะฑัะฐะฑะพัะบะฐ](#7-ะฟะพััะพะฑัะฐะฑะพัะบะฐ)
8. [ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะพะฟัะธะผะธะทะฐัะธะธ](#8-ัะตะบะพะผะตะฝะดะฐัะธะธ-ะฟะพ-ะพะฟัะธะผะธะทะฐัะธะธ)

---

## 1. ะะฑัะฐั ะธะดะตั

ะะปะฐััะตัะธะทะฐัะธั ะฟะพะธัะบะพะฒัั ะทะฐะฟัะพัะพะฒ ะฝะฐ ะพัะฝะพะฒะฐะฝะธะธ SERP (Search Engine Results Page) โ ััะพ ะผะตัะพะด ะณััะฟะฟะธัะพะฒะบะธ ะบะปััะตะฒัั ัะปะพะฒ ะฟะพ **ะพะฑัะธะผ URL ะฒ ะฟะพะธัะบะพะฒะพะน ะฒัะดะฐัะต**. ะะพะณะธะบะฐ ะฟัะพััะฐ: ะตัะปะธ ะดะฒะฐ ะทะฐะฟัะพัะฐ ะฒะพะทะฒัะฐัะฐัั ะพะดะฝะธ ะธ ัะต ะถะต URL ะฒ ะขะะ-10, ะทะฝะฐัะธั ะฟะพะธัะบะพะฒะฐั ัะธััะตะผะฐ ััะธัะฐะตั ะธั ัะตะผะฐะฝัะธัะตัะบะธ ะฑะปะธะทะบะธะผะธ ะธ ะธั ะผะพะถะฝะพ ะฟัะพะดะฒะธะณะฐัั ะฝะฐ ะพะดะฝะพะน ัััะฐะฝะธัะต.

### ะัะพะดะฝัะต ะดะฐะฝะฝัะต

| ะะพะปะต | ะะฟะธัะฐะฝะธะต |
|------|----------|
| `keyword` | ะะพะธัะบะพะฒัะน ะทะฐะฟัะพั |
| `url` | URL ะธะท ะขะะ-10 ะฒัะดะฐัะธ ะฟะพ ััะพะผั ะทะฐะฟัะพัั |

ะะฐะถะดัะน ะทะฐะฟัะพั ะธะผะตะตั ะดะพ 10 URL (ะฟะฐัะฐะผะตัั `MAX_URLS_PER_KW`).

### ะััะพะดะฝัะต ะดะฐะฝะฝัะต

ะะปั ะบะฐะถะดะพะณะพ ะทะฐะฟัะพัะฐ โ `cluster_id`, ะฟะพะบะฐะทัะฒะฐััะธะน, ะฒ ะบะฐะบัั ะณััะฟะฟั ะพะฝ ะฟะพะฟะฐะป. ะะฐะฟัะพัั ะฒะฝัััะธ ะพะดะฝะพะณะพ ะบะปะฐััะตัะฐ ะธะผะตัั ะพะฑัะธะต URL ะฒ ะฒัะดะฐัะต ะธ ะผะพะณัั ะฟัะพะดะฒะธะณะฐัััั ะฝะฐ ะพะดะฝะพะน ะฟะพัะฐะดะพัะฝะพะน ัััะฐะฝะธัะต.

---

## 2. ะััะธัะตะบัััะฐ ะฟะฐะนะฟะปะฐะนะฝะฐ

```
serp.parquet (ะทะฐะฟัะพั โ URL)
        โ
        โผ
โโโโโโโ-โโโโโโโโโโโโโโโโโโโโโโโ-โ
โ 1. ะะฐะณััะทะบะฐ ะธ ะบะพะดะธัะพะฒะฐะฝะธะต     |
| StringEncoder: ัััะพะบะธ โ int   |
โ    (38 ัะตะบ ะฝะฐ 7.5M ัััะพะบ)     โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
           โผ
โโโ-----------โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. ะะพัััะพะตะฝะธะต ััะฑะตั                               โ
| Inverted index: URL โ [ะทะฐะฟัะพัั]                   |
โ    (77 ัะตะบ)                                       |
|  ะะฐัะฐ (A,B) โ ัะตะฑัะพ ะตัะปะธ |SERP_A โฉ SERP_B| โฅ N    โ  
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. ะัะฐั (igraph) 760K ะฒะตััะธะฝ, 11M ััะฑะตั   |
โ    + ะบะพะผะฟะพะฝะตะฝัั ัะฒัะทะฝะพััะธ 185K ะบะพะผะฟะพะฝะตะฝั  |
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. ะะพะธัะบ ะบะปะธะบ              โ
| K-core split + fast_greedy |
โ    (147 ัะตะบ)               โ
| 352K ััััั ะบะปะธะบ            |
โโโโโโโโฌโโโโโโโโฌโโโโโโโโโโโโโโ
       โ       โ
       โผ       โผ
โโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโ
โ SOFT     โ โ HARD              โ
โ ะะพะฟะฐัะฝะพะต โ โ ะะปะพะฑะฐะปัะฝะฐั        โ
โ ััะปะพะฒะธะต  โ โ ะฟัะพะฒะตัะบะฐ + ััะถะตะฝะธะตโ
โ          โ โ (25 ะผะธะฝ)          โ
โโโโโโฌโโโโโโ โโโโโโฌโโโโโโโโโโโโโโโ
     โผ            โผ
โโโโโโโโโโโโโ  โโโโโโโโโโโโโ
โ ะะฐะทะฝะฐัะตะฝะธะตโ  โ ะะฐะทะฝะฐัะตะฝะธะตโ  ะะฐะดะฝะพะต: ะฑะพะปััะธะต ะบะปะธะบะธ ะฟะตัะฒัะผะธ
โ ะบะปะฐััะตัะพะฒ โ  โ ะบะปะฐััะตัะพะฒ โ
โโโโโโฌโโโโโโโ  โโโโโโฌโโโโโโโ
     โผ              โผ
โโโโโโโโโโโโ โโโโโโโโโโโโ
โ soft.    โ โ hard.    โ
โ parquet  โ โ parquet  โ
โโโโโโโโโโโโ โโโโโโโโโโโโ
        โ         โ
        โผ         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Merge + ะฟะพััะพะฑัะฐะฑะพัะบะฐ   โ  WS-ัะฐััะพัะฝะพััั, TOP URL,
โ โ Excel                 โ  TOP domains, main pages
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 3. Soft-ะบะปะฐััะตัะธะทะฐัะธั (ะฟะพะฟะฐัะฝะพะต ััะปะพะฒะธะต)

### ะัะธะฝัะธะฟ

**ะฃัะปะพะฒะธะต:** ะบะฐะถะดะฐั **ะฟะฐัะฐ** ะทะฐะฟัะพัะพะฒ ะฒ ะบะปะฐััะตัะต ะดะพะปะถะฝะฐ ะธะผะตัั โฅ N ะพะฑัะธั URL.

```
ะะฐะฟัะพั A โฉ ะะฐะฟัะพั B โฅ N  โ
ะะฐะฟัะพั A โฉ ะะฐะฟัะพั C โฅ N  โ
ะะฐะฟัะพั B โฉ ะะฐะฟัะพั C โฅ N  โ
โ {A, B, C} = ะบะปะธะบะฐ ะฒ ะณัะฐัะต
```

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

1. **ะัะฐั:** ะฒะตััะธะฝั โ ะทะฐะฟัะพัั, ัะตะฑัะพ ะผะตะถะดั A ะธ B ะตัะปะธ `|SERP_A โฉ SERP_B| โฅ MIN_COMMON_URLS`
2. **ะะปะธะบะธ:** ะธัะตะผ ะผะฐะบัะธะผะฐะปัะฝัะต ะบะปะธะบะธ โ ะฟะพะปะฝัะต ะฟะพะดะณัะฐัั, ะณะดะต ะบะฐะถะดะฐั ะฒะตััะธะฝะฐ ัะฒัะทะฐะฝะฐ ั ะบะฐะถะดะพะน
3. **ะะฐะทะฝะฐัะตะฝะธะต:** ะถะฐะดะฝะพ ะฝะฐะทะฝะฐัะฐะตะผ ะทะฐะฟัะพัั ะฒ ะบะปะฐััะตัั, ะฝะฐัะธะฝะฐั ั ัะฐะผัั ะฑะพะปััะธั ะบะปะธะบ

### ะัะพะฑะตะฝะฝะพััั

ะะพะฟะฐัะฝะพะต ััะปะพะฒะธะต **ะฝะต ะณะฐัะฐะฝัะธััะตั** ะพะฑัะธะต URL ะดะปั ะะกะะฅ ะทะฐะฟัะพัะพะฒ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ. ะัะธะผะตั:

```
A โฉ B = {url1, url2, url3}       โ 3 ะพะฑัะธั โ
A โฉ C = {url4, url5, url6}       โ 3 ะพะฑัะธั โ
B โฉ C = {url7, url8, url9}       โ 3 ะพะฑัะธั โ
A โฉ B โฉ C = {}                    โ 0 ะพะฑัะธั!
```

ะัะต ะฟะฐัั ัะดะพะฒะปะตัะฒะพัััั ััะปะพะฒะธั, ะฝะพ ะฝะธ ะพะดะธะฝ URL ะฝะต ะฟัะธัััััะฒัะตั ะฒะพ ะะกะะฅ ัััั ะทะฐะฟัะพัะฐั.

### ะะตะทัะปััะฐั ะฝะฐ ะดะฐะฝะฝัั (760K ะทะฐะฟัะพัะพะฒ, MIN_COMMON=4)

- **249,602** ะบะปะฐััะตัะพะฒ (ะธะท ะฝะธั 108,003 ะผัะปััะธ)
- ะกัะตะดะฝะธะน ัะฐะทะผะตั ะผัะปััะธ-ะบะปะฐััะตะฐ: **5.7** ะทะฐะฟัะพัะพะฒ
- ะะฐะบัะธะผะฐะปัะฝัะน ัะฐะทะผะตั ะบะปะฐััะตัะฐ: **1,302** ะทะฐะฟัะพัะฐ

---

## 4. Hard-ะบะปะฐััะตัะธะทะฐัะธั (ะณะปะพะฑะฐะปัะฝะพะต ััะปะพะฒะธะต)

### ะัะธะฝัะธะฟ

**ะฃัะปะพะฒะธะต:** **ะะกะ** ะทะฐะฟัะพัั ะฒ ะบะปะฐััะตัะต ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ะดะพะปะถะฝั ะธะผะตัั โฅ N ะพะฑัะธั URL.

```
ะะฐะฟัะพั A โฉ ะะฐะฟัะพั B โฉ ะะฐะฟัะพั C โฅ N
โ ะกััะตััะฒัะตั ะผะธะฝะธะผัะผ N URL, ะบะพัะพััะต ัะฐะฝะถะธัััััั ะฒ ะขะะ-10 ะฟะพ ะะกะะ ะทะฐะฟัะพัะฐะผ ะบะปะฐััะตัะฐ
```

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

1. **ะคะฐะทะฐ 1 (ะบะฐะบ Soft):** ัััะพะธะผ ะณัะฐั โ ะธัะตะผ ะบะปะธะบะธ (ะฟะพะฟะฐัะฝะพะต ััะปะพะฒะธะต)
2. **ะคะฐะทะฐ 2 (ะณะปะพะฑะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ):** ะดะปั ะบะฐะถะดะพะน ะบะปะธะบะธ ะฒััะธัะปัะตะผ ะฟะตัะตัะตัะตะฝะธะต URL ะะกะะฅ ะทะฐะฟัะพัะพะฒ:
   - ะัะปะธ `|โฉ URL| โฅ N` โ ะบะปะธะบะฐ ะฟัะพัะพะดะธั ะฑะตะท ะธะทะผะตะฝะตะฝะธะน โ
   - ะัะปะธ `|โฉ URL| < N` โ **ััะถะตะฝะธะต**: ะธัะตัะฐัะธะฒะฝะพ ัะฑะธัะฐะตะผ ยซัะปะฐะฑัะนยป ะทะฐะฟัะพั (ัะพั, ััั ัะดะฐะปะตะฝะธะต ะผะฐะบัะธะผะฐะปัะฝะพ ัะฒะตะปะธัะธะฒะฐะตั ะณะปะพะฑะฐะปัะฝะพะต ะฟะตัะตัะตัะตะฝะธะต) ะธ ะฟะพะฒัะพััะตะผ
   - ะัะปะธ ะฟะพัะปะต ััะถะตะฝะธั ะพััะฐะปะพัั `< MIN_CLIQUE_SIZE` ะทะฐะฟัะพัะพะฒ โ ะบะปะธะบะฐ ะพัะฑัะฐััะฒะฐะตััั โ

### ะะปะณะพัะธัะผ ััะถะตะฝะธั ะบะปะธะบะธ

```python
while len(clique) >= min_clique_size:
    common = โฉ URL ะฒัะตั ะทะฐะฟัะพัะพะฒ ะฒ ะบะปะธะบะต
    if |common| >= min_common:
        break  # OK

    # ะะฐัะพะดะธะผ "ัะปะฐะฑัะน" ะทะฐะฟัะพั
    for ะบะฐะถะดะพะณะพ ะทะฐะฟัะพัะฐ kw ะฒ ะบะปะธะบะต:
        trial = โฉ URL ะฒัะตั ะะะะะ kw
        ะตัะปะธ trial > best โ ะทะฐะฟะพะผะธะฝะฐะตะผ kw ะบะฐะบ ะบะฐะฝะดะธะดะฐัะฐ ะฝะฐ ัะดะฐะปะตะฝะธะต

    ัะดะฐะปัะตะผ ัะปะฐะฑัะน ะทะฐะฟัะพั ะธะท ะบะปะธะบะธ
```

### ะะฐัะตะผ ะฝัะถะฝะฐ ะคะฐะทะฐ 2?

ะะปะธะบะธ ะธะท ะคะฐะทั 1 ะณะฐัะฐะฝัะธัััั ัะพะปัะบะพ ะฟะพะฟะฐัะฝะพะต ััะปะพะฒะธะต. ะะพ ะดะปั ัะฐััะธ ัะตะผะฐัะธะบ, ะณะดะต ะบะพะฝะบััะตะฝัะธั ะทะฐ ะขะะ ะพัะพะฑะตะฝะฝะพ ะฒััะพะบะฐ - ะฝะตะพะฑัะพะดะธะผะฐ ะฑะพะปะตะต ัััะพะณะฐั ะบะปะฐััะตัะธะทะฐัะธั - ะบะพะณะดะฐ ั ะฒัะตั ะทะฐะฟัะพัะพะฒ ะบะปะฐััะตัะฐ ะตััั ะฝะฐะฑะพั ะพะฑัะธั URL

### ะะตะทัะปััะฐั ะฝะฐ ะดะฐะฝะฝัั

- ะะท 352,486 ััััั ะบะปะธะบ:
  - **230,468** ะฟัะพัะปะธ ะฑะตะท ะธะทะผะตะฝะตะฝะธะน
  - **410,085** ะฑัะปะธ ััะถะตะฝั (ะพะดะฝะฐ ะบะปะธะบะฐ ะผะพะถะตั ะดะฐัั ะฝะตัะบะพะปัะบะพ ะฟะพะดะบะปะธะบ)
  - **0** ะพัะฑัะพัะตะฝั ะฟะพะปะฝะพัััั
- ะคะธะฝะฐะป: **262,163** ะบะปะฐััะตัะฐ (111,856 ะผัะปััะธ)
- ะกัะตะดะฝะธะน ะผัะปััะธ-ะบะปะฐััะตั: **5.5** ะทะฐะฟัะพัะพะฒ
- ะะฑัะธั URL: ััะตะดะฝะตะต **5.7**, ะผะธะฝะธะผัะผ **4**, ะผะฐะบัะธะผัะผ **10**

---

## 5. ะกัะฐะฒะฝะตะฝะธะต Soft ะธ Hard

| ะฅะฐัะฐะบัะตัะธััะธะบะฐ | Soft (ะฟะพะฟะฐัะฝะพะต) | Hard (ะณะปะพะฑะฐะปัะฝะพะต) |
|---|---|---|
| **ะฃัะปะพะฒะธะต** | ะะฐะถะดะฐั ะฟะฐัะฐ โฅ N ะพะฑัะธั URL | ะะกะ ะทะฐะฟัะพัั โฅ N ะพะฑัะธั URL |
| **ะกััะพะณะพััั** | ะัะณะบะพะต | ะกััะพะณะพะต (Hard โ Soft) |
| **ะะฐะทะผะตั ะบะปะฐััะตัะพะฒ** | ะะพะปััะต (ััะตะดะฝะตะต 5.7) | ะะตะฝััะต (ััะตะดะฝะตะต 5.5) |
| **ะะฐะบัะธะผะฐะปัะฝัะน ะบะปะฐััะตั** | 1,302 | 1,266 |
| **ะะฐัะฐะฝัะธั ะพะฑัะธั URL** | ะะตั (ะผะพะถะตั ะฑััั 0) | ะะฐ (โฅ N ะดะปั ะฒัะตั) |
| **ะัะธะผะตะฝะตะฝะธะต** | ะจะธัะพะบะฐั ะณััะฟะฟะธัะพะฒะบะฐ ัะตะผ | ะขะพัะฝะฐั ะฟัะพะฒะตัะบะฐ |
| **ะัะตะผั** | ะััััะพ | +25 ะผะธะฝ ะฝะฐ ะณะปะพะฑะฐะปัะฝัั ะฟัะพะฒะตัะบั |
| **ะงะธัะปะพ ะบะปะฐััะตัะพะฒ** | 249,602 | 262,163 |

### ะะพะณะดะฐ ะธัะฟะพะปัะทะพะฒะฐัั ััะพ

**Soft** ะฟะพะดัะพะดะธั ะดะปั:
- ะะตัะฒะธัะฝะพะน ะณััะฟะฟะธัะพะฒะบะธ ัะตะผะฐะฝัะธะบะธ
- ะะฟัะตะดะตะปะตะฝะธั ัะตะผะฐัะธัะตัะบะธั ะฝะฐะฟัะฐะฒะปะตะฝะธะน
- ะะพะณะดะฐ ะดะพะฟัััะธะผะฐ ะฝะตัััะบะฐั ะณััะฟะฟะธัะพะฒะบะฐ
- ะัะธ ะฟัะพะดะฒะธะถะตะฝะธะธ ะบะพะฝัะตะฝั ะฟัะพะตะบัะตะพะฒ

**Hard** ะฟะพะดัะพะดะธั ะดะปั:
- ะะฟัะตะดะตะปะตะฝะธั ะบะพะฝะบัะตัะฝัั ะฟะพัะฐะดะพัะฝัั ัััะฐะฝะธั
- ะะพะณะดะฐ ะฝัะถะฝะฐ ะณะฐัะฐะฝัะธั, ััะพ ะฒัะต ะทะฐะฟัะพัั ะบะปะฐััะตัะฐ ะผะพะถะฝะพ ะฟัะพะดะฒะธะฝััั ะพะดะฝะธะผ URL
- ะัะธะผะตะฝััะตัั ะบะฐะบ ะฟัะฐะฒะธะปะพ ะฟัะธ ะฟัะพะดะธะถะตะฝะธะธ ะฟะพ ะฟะพะทะธัะธัะผัั

### ะะธะทัะฐะปัะฝะพะต ััะฐะฒะฝะตะฝะธะต

```
Soft ะบะปะฐััะตั {A, B, C, D, E}:
  AโฉB=4 โ  AโฉC=4 โ  AโฉD=4 โ  AโฉE=4 โ
  BโฉC=4 โ  BโฉD=4 โ  BโฉE=4 โ
  CโฉD=4 โ  CโฉE=4 โ  DโฉE=4 โ
  ะะพ AโฉBโฉCโฉDโฉE = 1 URL โ ะฝะตะดะพััะฐัะพัะฝะพ ะดะปั Hard

Hard ะฟะพัะปะต ััะถะตะฝะธั:
  {A, C, E} โ AโฉCโฉE = 4 URL โ
  {B, D}    โ BโฉD = 4 URL โ   (ะพัะดะตะปัะฝัะน ะบะปะฐััะตั)
```
![Soft vs Hard ะบะปะฐััะตั](soft_vs_hard_serp_clustering.png)
---

## 6. ะะตัะฐะปัะฝะพะต ะพะฟะธัะฐะฝะธะต ะบะฐะถะดะพะณะพ ัะฐะณะฐ

### 6.1. ะะพะฝัะธะณััะฐัะธั (ะกะตะบัะธั 1)

| ะะฐัะฐะผะตัั | ะะฝะฐัะตะฝะธะต | ะะฟะธัะฐะฝะธะต |
|---|---|---|
| `MIN_COMMON_URLS` | 4 | ะะธะฝะธะผะฐะปัะฝะพะต ัะธัะปะพ ะพะฑัะธั URL ะดะปั ัะตะฑัะฐ |
| `MAX_URLS_PER_KW` | 10 | ะะฐะบัะธะผัะผ URL ะฝะฐ ะทะฐะฟัะพั (ะขะะ-10) |
| `MIN_CLIQUE_SIZE` | 2 | ะะธะฝะธะผะฐะปัะฝัะน ัะฐะทะผะตั ะบะปะฐััะตัะฐ |
| `DEGENERACY_LIMIT` | 50 | ะะพัะพะณ: igraph ัะพัะฝัะน โค 50, greedy > 50 |
| `EDGE_METHOD` | inverted_index | ะะตัะพะด ะฟะพัััะพะตะฝะธั ััะฑะตั |

### 6.2. StringEncoder (ะกะตะบัะธั 3)

ะะพะดะธััะตั ัััะพะบะธ (ะทะฐะฟัะพัั ะธ URL) ะฒ ัะตะปัะต ัะธัะปะฐ ะดะปั ัะบะพะฝะพะผะธะธ ะฟะฐะผััะธ ะธ ััะบะพัะตะฝะธั ะพะฟะตัะฐัะธะน. ะะผะตััะพ ััะฐะฝะตะฝะธั ัััะพะบ ะฒ set/dict ะธัะฟะพะปัะทััััั int-ะธะดะตะฝัะธัะธะบะฐัะพัั.

```
"ะณะพััะธะฝะธัะฐ ะผะพัะบะฒะฐ" โ 0
"ะพัะตะปั ะผะพัะบะฒะฐ"     โ 1
"https://booking.com/..." โ 0
```

### 6.3. ะะฐะณััะทะบะฐ ะดะฐะฝะฝัั (ะกะตะบัะธั 4)

ะงะธัะฐะตั CSV ัะฐะฝะบะฐะผะธ ะฟะพ 500K ัััะพะบ. ะะปั ะบะฐะถะดะพะณะพ ะทะฐะฟัะพัะฐ ัะพัะผะธััะตั ะผะฝะพะถะตััะฒะพ URL-ะธะดะตะฝัะธัะธะบะฐัะพัะพะฒ (ะฝะต ะฑะพะปะตะต `MAX_URLS_PER_KW`). ะะตะทัะปััะฐั: `kw2urls: Dict[int, Set[int]]`.

### 6.4. ะะพัััะพะตะฝะธะต ััะฑะตั (ะกะตะบัะธั 5)

**Inverted Index ะผะตัะพะด:**

1. ะกััะพะธะผ ะพะฑัะฐัะฝัะน ะธะฝะดะตะบั: `URL โ [ัะฟะธัะพะบ ะทะฐะฟัะพัะพะฒ]`
2. ะะปั ะบะฐะถะดะพะณะพ URL ะฟะตัะตะฑะธัะฐะตะผ ะฒัะต ะฟะฐัั ะทะฐะฟัะพัะพะฒ, ะบะพัะพััะต ะตะณะพ ัะพะดะตัะถะฐั
3. ะกัะธัะฐะตะผ ัะธัะปะพ ะพะฑัะธั URL ะดะปั ะบะฐะถะดะพะน ะฟะฐัั
4. ะััะฐะฒะปัะตะผ ะฟะฐัั ั โฅ `MIN_COMMON_URLS` ะพะฑัะธั

**Sparse Matrix ะผะตัะพะด** (ะฐะปััะตัะฝะฐัะธะฒะฝัะน, ะดะปั >100K ะทะฐะฟัะพัะพะฒ):

1. ะกััะพะธะผ ะฑะธะฝะฐัะฝัั ะผะฐััะธัั `ะทะฐะฟัะพัั ร URL`
2. ะฃะผะฝะพะถะฐะตะผ `A ร A^T` โ ะฟะพะปััะฐะตะผ ะผะฐััะธัั ะฟะตัะตัะตัะตะฝะธะน
3. ะคะธะปััััะตะผ ะฟะพ ะฟะพัะพะณั

### 6.5. ะัะฐั ะธ ะบะพะผะฟะพะฝะตะฝัั (ะกะตะบัะธั 6)

ะกััะพะธะผ ะฝะตะพัะธะตะฝัะธัะพะฒะฐะฝะฝัะน ะณัะฐั ะฒ igraph, ะฝะฐัะพะดะธะผ ะบะพะผะฟะพะฝะตะฝัั ัะฒัะทะฝะพััะธ. ะะฐะถะดะฐั ะบะพะผะฟะพะฝะตะฝัะฐ ะพะฑัะฐะฑะฐััะฒะฐะตััั ะฝะตะทะฐะฒะธัะธะผะพ โ ััะพ ะฟะพะทะฒะพะปัะตั ะฟะฐัะฐะปะปะตะปะธะทะฐัะธั ะธ ะพะฟัะธะผะธะทะฐัะธั.

ะกัะฐัะธััะธะบะฐ ะบะพะผะฟะพะฝะตะฝั (760K ะทะฐะฟัะพัะพะฒ):
- 117,349 ะพะดะธะฝะพัะฝัั (ะฝะตั ััะฑะตั)
- 57,445 ะผะตะปะบะธั (2-10 ะฒะตััะธะฝ)
- ะกะฐะผะฐั ะฑะพะปััะฐั: 63,449 ะฒะตััะธะฝ

### 6.6. ะะพะธัะบ ะบะปะธะบ v2.2 (ะกะตะบัะธั 8)

#### ะัะพะฑะปะตะผะฐ

ะะพะธัะบ ะฒัะตั ะผะฐะบัะธะผะฐะปัะฝัั ะบะปะธะบ โ NP-hard ะทะฐะดะฐัะฐ. ะกะปะพะถะฝะพััั `O(dยทnยท3^(d/3))` ะณะดะต d โ degeneracy ะณัะฐัะฐ. ะัะธ d=1327 (ะฝะฐัะฐ ะบะพะผะฟะพะฝะตะฝัะฐ #1) ะฟะพะปะฝัะน ะฟะตัะตะฑะพั ะฝะตะฒะพะทะผะพะถะตะฝ.

#### ะะตัะตะฝะธะต: K-core ัััะฐัะธัะธะบะฐัะธั

1. ะััะธัะปัะตะผ coreness ะบะฐะถะดะพะน ะฒะตััะธะฝั
2. ะะฐะทะดะตะปัะตะผ ะบะพะผะฟะพะฝะตะฝัั ะฝะฐ **shell** (coreness โค 50) ะธ **core** (coreness > 50)
3. Shell โ igraph `maximal_cliques()` (ัะพัะฝัะน ะฐะปะณะพัะธัะผ)
4. Core โ `fast_greedy_cliques()` (ะถะฐะดะฝะฐั ะฐะฟะฟัะพะบัะธะผะฐัะธั)

#### Fast Greedy Cliques (v2.2)

ะะปััะตะฒัะต ะพะฟัะธะผะธะทะฐัะธะธ ะฟะพ ััะฐะฒะฝะตะฝะธั ั v2.1:

1. **Pre-computed adjacency sets**: ะบะพะฝะฒะตััะธััะตะผ igraph ะฒ `Dict[int, Set[int]]` ะพะดะธะฝ ัะฐะท
2. **Pre-sorted seeds**: ะฒะตััะธะฝั ะพััะพััะธัะพะฒะฐะฝั ะฟะพ degree ะพะดะธะฝ ัะฐะท
3. **Candidate pruning**: `remaining &= adj[v]` โ ะฟัะธ ะบะฐะถะดะพะผ ะดะพะฑะฐะฒะปะตะฝะธะธ ะฒะตััะธะฝั ะฒ ะบะปะธะบั ะผะฝะพะถะตััะฒะพ ะบะฐะฝะดะธะดะฐัะพะฒ ััะถะฐะตััั

```
ะกะปะพะถะฝะพััั:
  v2.1: O(Nยฒ ร D) โ ัะฐัั ะฝะฐ 114K ะฒะตััะธะฝ
  v2.2: O(N ร D)  โ ัะตะบัะฝะดั
```

### 6.7. ะะปะพะฑะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ (ะกะตะบัะธั Hard)

ะคัะฝะบัะธั `enforce_global_condition_igraph_iterative`:

- ะะปั ะบะฐะถะดะพะน ัััะพะน ะบะปะธะบะธ ะฒััะธัะปัะตั `โฉ URL` ะฒัะตั ะทะฐะฟัะพัะพะฒ
- ะัะปะธ ะฟะตัะตัะตัะตะฝะธะต < ะฟะพัะพะณะฐ โ ะธัะตัะฐัะธะฒะฝะพ ัะฑะธัะฐะตั ยซัะปะฐะฑัะตยป ะทะฐะฟัะพัั
- ะะดะฝะฐ ะบะปะธะบะฐ ะผะพะถะตั ะฟะพัะพะดะธัั ะฝะตัะบะพะปัะบะพ ะฟะพะดะบะปะธะบ (ัะตัะตะท ััะถะตะฝะธะต)

ะะตะทัะปััะฐั: ะธะท 352K ััััั ะบะปะธะบ โ 640K ะบะปะธะบ ั ะณะปะพะฑะฐะปัะฝัะผ ััะปะพะฒะธะตะผ.

### 6.8. ะะฐะทะฝะฐัะตะฝะธะต ะบะปะฐััะตัะพะฒ (ะกะตะบัะธั 9-10)

**ะะฐะดะฝัะน ัะบัะบะปัะทะธะฒะฝัะน ะฐะปะณะพัะธัะผ:**

1. ะกะพััะธััะตะผ ะบะปะธะบะธ ะฟะพ ัะฐะทะผะตัั (ะพั ะฑะพะปััะธั ะบ ะผะฐะปะตะฝัะบะธะผ)
2. ะะปั ะบะฐะถะดะพะน ะบะปะธะบะธ:
   - ะะตััะผ ัะพะปัะบะพ ะตัั ะฝะต ะฝะฐะทะฝะฐัะตะฝะฝัะต ะทะฐะฟัะพัั
   - ะัะพะฒะตััะตะผ, ััะพ ะธั โฅ `MIN_CLIQUE_SIZE`
   - (Hard) ะะตัะตััะธััะฒะฐะตะผ ะณะปะพะฑะฐะปัะฝะพะต ะฟะตัะตัะตัะตะฝะธะต ะดะปั ะพััะฐะฒัะธััั
   - ะะฐะทะฝะฐัะฐะตะผ `cluster_id`
3. ะัะต ะฝะตะฝะฐะทะฝะฐัะตะฝะฝัะต ะทะฐะฟัะพัั โ ะพะดะธะฝะพัะฝัะต ะบะปะฐััะตัั

---

## 7. ะะพััะพะฑัะฐะฑะพัะบะฐ

### Merge Soft + Hard

ะะฑัะตะดะธะฝะตะฝะธะต ะพะฑะพะธั ัะธะฟะพะฒ ะบะปะฐััะตัะธะทะฐัะธะธ ะฟะพ ะบะปััะตะฒะพะผั ัะปะพะฒั. ะะพะทะฒะพะปัะตั ะฒะธะดะตัั, ะบะฐะบ ะทะฐะฟัะพั ะณััะฟะฟะธััะตััั ะฒ ะพะฑะพะธั ัะตะถะธะผะฐั.

### Merge ั ัะฐััะพัะฝะพัััั (WS)

ะัะธัะพะตะดะธะฝะตะฝะธะต ัะฐััะพัะฝะพััะธ ะธะท Wordstat (`sum`) ะดะปั ะฟัะธะพัะธัะธะทะฐัะธะธ ะทะฐะฟัะพัะพะฒ ะฒะฝัััะธ ะบะปะฐััะตัะฐ.

### TOP URL ะฟะพ ะบะปะฐััะตัั

ะะปั ะบะฐะถะดะพะณะพ ะบะปะฐััะตัะฐ ะฟะพะดััะธััะฒะฐะตััั, ัะบะพะปัะบะพ ัะฐะท ะบะฐะถะดัะน URL ะฒัััะตัะฐะตััั ะฒ ะฒัะดะฐัะต ะทะฐะฟัะพัะพะฒ ะบะปะฐััะตัะฐ. ะกะฐะผัะน ัะฐัััะน URL โ ะปัััะธะน ะบะฐะฝะดะธะดะฐั ะฝะฐ ะฟะพัะฐะดะพัะฝัั ัััะฐะฝะธัั.

### ะะพะดัััั ะผะพัะด (main pages)

ะะฟัะตะดะตะปะตะฝะธะต, ัะบะพะปัะบะพ ะณะปะฐะฒะฝัั ัััะฐะฝะธั (ะดะพะผะตะฝ ะฑะตะท ะฟััะธ) ัะฐะฝะถะธััะตััั ะฟะพ ะทะฐะฟัะพัั. ะััะพะบะพะต ัะธัะปะพ ะผะพัะด = ะฝะฐะฒะธะณะฐัะธะพะฝะฝัะน/ะฑัะตะฝะดะพะฒัะน ะธะฝัะตะฝั.

### TOP URL ะธ TOP Domains

ะะฑัะฐั ะฐะฝะฐะปะธัะธะบะฐ: ัะฐะผัะต ัะฐัััะต URL ะธ ะดะพะผะตะฝั ะฒ SERP-ะดะฐะฝะฝัั.

---

## 8. ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะพะฟัะธะผะธะทะฐัะธะธ

### ๐ด ะัะธัะธัะตัะบะธะต (ะฑะพะปััะพะน ัััะตะบั)

#### 8.1. ะะตะบัะพัะธะทะฐัะธั `get_domain()` ะธ `main_url()`

**ะัะพะฑะปะตะผะฐ:** `.apply()` ะฟะพ 7.5M ัััะพะบ โ ััะพ Python-ัะธะบะป, ะทะฐะฝะธะผะฐะตั ะผะธะฝััั.

**ะะตัะตะฝะธะต:**

```python
# ะะผะตััะพ apply + urlparse:

# get_domain โ ะฒะตะบัะพัะธะทะพะฒะฐะฝะฝะพ
serp['domain'] = serp['url'].str.extract(r'https?://([^/:]+)', expand=False)

# main_url โ ะฒะตะบัะพัะธะทะพะฒะฐะฝะฝะพ
parsed = serp['url'].str.extract(r'https?://[^/]+(.*)', expand=False).fillna('/')
serp['main_page'] = (parsed.isin(['', '/'])).astype(int)
```

**ะฃัะบะพัะตะฝะธะต:** ~50-100x (ะผะธะฝััั โ ัะตะบัะฝะดั).

#### 8.2. Cap ะฝะฐ URL ะฒ inverted index

**ะัะพะฑะปะตะผะฐ:** URL `yandex.ru/...` ะฒัััะตัะฐะตััั ะฒ 462K ะทะฐะฟัะพัะฐั. ะะตัะตะฑะพั ะฒัะตั ะฟะฐั = C(462K, 2) โ 107 ะผะปัะด ะพะฟะตัะฐัะธะน ะดะปั ะพะดะฝะพะณะพ URL.

ะขะตะบััะธะน ะบะพะด ัะถะต ัะพััะธััะตั ะฟะพ ัะธัะปั ะทะฐะฟัะพัะพะฒ ะธ ะพััะฐะฑะฐััะฒะฐะตั ััะพ, ะฝะพ ัะฒะฝัะน cap ััะบะพัะธั ะธ ัะปัััะธั ะบะฐัะตััะฒะพ โ ัะปะธัะบะพะผ ะพะฑัะธะต URL ะฝะตะธะฝัะพัะผะฐัะธะฒะฝั (ะบะฐะบ ััะพะฟ-ัะปะพะฒะฐ):

```python
MAX_KW_PER_URL = 5000  # ะฝะฐัััะฐะธะฒะฐะตะผัะน ะฟะพัะพะณ

for url_id, kw_list in url2kws.items():
    if len(kw_list) > MAX_KW_PER_URL:
        continue  # ัะปะธัะบะพะผ ะพะฑัะธะน URL, ะฟัะพะฟััะบะฐะตะผ
    # ... ะพะฑัะฐะฑะพัะบะฐ ะฟะฐั
```

#### 8.3. ะะฐะณ ะฒ ะฒะฐะปะธะดะฐัะธะธ

**ะัะพะฑะปะตะผะฐ:** ะฒัะฒะพะด ะฒะฐะปะธะดะฐัะธะธ ะฟะพะบะฐะทัะฒะฐะตั `"ะฒัะต โฅ3"`, ัะพัั `MIN_COMMON_URLS=4`. ะคัะฝะบัะธั ะฟัะธะฝะธะผะฐะตั `min_common` ะฟะฐัะฐะผะตััะพะผ, ะฝะพ ัััะพะบะฐ ะฒัะฒะพะดะฐ ัะธะบัะธัะพะฒะฐะฝะฐ ะธะท ะฟัะพัะปะพะณะพ ัะฐะฝะฐ. ะฃะฑะตะดะธัะตัั, ััะพ ะฟัะธ ะบะฐะถะดะพะผ ะทะฐะฟััะบะต ะฟะตัะตะดะฐัััั ะฐะบััะฐะปัะฝะพะต ะทะฝะฐัะตะฝะธะต.

### ๐ก ะะฐะถะฝัะต (ััะตะดะฝะตะต ััะบะพัะตะฝะธะต)

#### 8.4. ะคะธะฝะฐะปัะฝัะน Excel-ัะบัะฟะพัั

**ะัะพะฑะปะตะผะฐ:** ะทะฐะฟะธัั 760K ัััะพะบ + ะฝะตัะบะพะปัะบะพ ะปะธััะพะฒ ะฒ Excel โ ะผะตะดะปะตะฝะฝะพ ะธ ัะฐะนะป ััะถัะปัะน.

**ะะตัะตะฝะธะต:**

```python
# ะัะฝะพะฒะฝะพะน ัะตะทัะปััะฐั โ parquet (ะฑััััะพ, ะบะพะผะฟะฐะบัะฝะพ)
result.to_parquet('hotel_4_hard.parquet', index=False)

# ะะฝะฐะปะธัะธะบั (top_urls, top_domains) โ ะพัะดะตะปัะฝัะต parquet
url_count_by_category.to_parquet('url_count_by_category.parquet')
top_urls.to_parquet('top_urls.parquet')
top_domains.to_parquet('top_domains.parquet')

# ะัะปะธ ะฝัะถะตะฝ Excel ะดะปั ะผะตะฝะตะดะถะตัะพะฒ โ ััะผะฟะปะธัั ะธะปะธ ะฐะณัะตะณะธัะพะฒะฐัั
```

#### 8.5. ะะฐัะฐะปะปะตะปัะฝะฐั ะณะปะพะฑะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ

**ะัะพะฑะปะตะผะฐ:** `enforce_global_condition` โ 25 ะผะธะฝัั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ.

**ะะตัะตะฝะธะต:** ะบะปะธะบะธ ะฝะตะทะฐะฒะธัะธะผั ะดััะณ ะพั ะดััะณะฐ, ะผะพะถะฝะพ ะพะฑัะฐะฑะฐััะฒะฐัั ะฑะฐััะฐะผะธ ะฒ `ProcessPoolExecutor`:

```python
from concurrent.futures import ProcessPoolExecutor

def process_clique_batch(batch, kw2urls, min_common, min_size):
    results = []
    for clique in batch:
        # ... enforce logic
        results.append(...)
    return results

batches = [cliques[i:i+1000] for i in range(0, len(cliques), 1000)]
with ProcessPoolExecutor(max_workers=NUM_WORKERS) as pool:
    futures = [pool.submit(process_clique_batch, b, kw2urls, ...) for b in batches]
```

#### 8.6. ะงัะตะฝะธะต SERP ะธะท parquet ะฒะผะตััะพ CSV

ะะฐะณััะทะบะฐ ะธะดัั ัะตัะตะท `load_serp_csv()` (ัะตะบัะธั 4), ัะพัั ะดะฐะฝะฝัะต ัะถะต ัะพััะฐะฝะตะฝั ะฒ `serp_data.parquet`. ะะพะถะฝะพ ะฝะฐะฟะธัะฐัั `load_serp_parquet()` โ ะฑัะดะตั ะฑััััะตะต ะฒ 3-5 ัะฐะท ะธ ะฝะต ะฝัะถะฝะฐ ะฟัะพะผะตะถััะพัะฝะฐั CSV-ะบะพะฝะฒะตััะฐัะธั.

### ๐ข ะะตะปะบะธะต ัะปัััะตะฝะธั

#### 8.7. ะะพัะผะฐะปะธะทะฐัะธั `common_urls` ะฒ ัะบัะฟะพััะต

ะะพะปะพะฝะบะฐ `common_urls` ัะพะดะตัะถะธั ะดะปะธะฝะฝัะต ัััะพะบะธ ั `" | "` ัะฐะทะดะตะปะธัะตะปะตะผ. ะะปั ะฑะพะปััะธั ะบะปะฐััะตัะพะฒ ััะฐ ัััะพะบะฐ ะดัะฑะปะธััะตััั ัะพัะฝะธ ัะฐะท. ะะฐัะธะฐะฝัั:

- ะฅัะฐะฝะธัั `common_urls` ะฒ ะพัะดะตะปัะฝะพะน ัะฐะฑะปะธัะต `cluster_id โ urls`
- ะะปะธ ะธัะฟะพะปัะทะพะฒะฐัั `list` ัะธะฟ ะฒ parquet (pyarrow ะฟะพะดะดะตัะถะธะฒะฐะตั)

#### 8.8. ะััััะต ััะตะนะบะธ ะฒ ะฝะพััะฑัะบะต

ะะตัะบะพะปัะบะพ ะฟััััั code-ััะตะตะบ ะธ ะฝะตะธัะฟะพะปัะทัะตะผัะน ะบะพะด โ ััะพะธั ะฟะพัะธััะธัั ะดะปั ัะธัะฐะตะผะพััะธ.

#### 8.9. ะฃะฟัะฐะฒะปะตะฝะธะต ะฟะฐะผัััั

ะะพัะปะต ะทะฐะณััะทะบะธ SERP ะฒ ะฟะพััะพะฑัะฐะฑะพัะบะต ะฒ ะฟะฐะผััะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ะฝะฐัะพะดัััั: `kw2urls`, `G` (ะณัะฐั), `raw_cliques_kw`, `cliques_global`, `kw2cluster`, `result_df`, `serp`, `merged_df`. ะะฐ 760K ะทะฐะฟัะพัะพะฒ ััะพ 10-15 GB. ะะตะบะพะผะตะฝะดัะตััั ะพัะฒะพะฑะพะถะดะฐัั ะฟัะพะผะตะถััะพัะฝัะต ััััะบัััั:

```python
del G, kw2vertex, vertex2kw, components
del raw_cliques_kw, cliques_global
gc.collect()
# ... ะฟะพัะพะผ ะทะฐะณััะถะฐะตะผ serp ะดะปั ะฟะพััะพะฑัะฐะฑะพัะบะธ
```

---

## ะัะธะปะพะถะตะฝะธะต: ะะฐัะฐะผะตััั ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั

| ะะตััะธะบะฐ | ะะฝะฐัะตะฝะธะต |
|---|---|
| ะะฐะฟัะพัะพะฒ | 760,992 |
| URL ะฒ SERP | 2,417,211 |
| ะกััะพะบ SERP | 7,550,791 |
| ะัะฑะตั ะฒ ะณัะฐัะต | 10,971,176 |
| ะกัััั ะบะปะธะบ | 352,486 |
| Hard-ะบะปะฐััะตัะพะฒ | 262,163 (111,856 ะผัะปััะธ) |
| Soft-ะบะปะฐััะตัะพะฒ | 249,602 (108,003 ะผัะปััะธ) |
| ะะฑัะตะต ะฒัะตะผั (ะฑะตะท ะฟะพััะพะฑัะฐะฑะพัะบะธ) | ~30 ะผะธะฝ |
| ะะธะบะพะฒะฐั RAM | ~12-15 GB |

